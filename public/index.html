<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vervegrand Sync Paneli</title>
    <style>
        :root {
            --bg-color: #f4f6f8; --card-bg: #ffffff; --text-color: #333; --primary-color: #5a67d8;
            --border-color: #e2e8f0; --success-color: #38a169; --error-color: #e53e3e; --warn-color: #dd6b20;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        h1 { font-size: 1.75rem; margin: 0; }
        nav { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem; margin-bottom: 2rem; display: flex; gap: 0.5rem; }
        .nav-link { padding: 0.75rem 1.25rem; text-decoration: none; color: #555; font-weight: 600; border-radius: 6px; transition: background-color 0.2s, color 0.2s; }
        .nav-link:hover { background-color: #edf2f7; }
        .nav-link.active { background-color: var(--primary-color); color: white; }
        .page { display: none; }
        .page.active { display: block; }
        .card { background-color: var(--card-bg); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); border: 1px solid var(--border-color); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .card h2 { font-size: 1.25rem; margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 0.75rem; margin-bottom: 1rem; }
        .info-grid { display: grid; grid-template-columns: 150px 1fr; gap: 0.5rem; align-items: center; }
        .info-grid dt { font-weight: 600; color: #555; }
        .info-grid dd { margin: 0; font-family: "SF Mono", "Fira Code", monospace; word-break: break-all; }
        .status { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8rem; font-weight: 600; }
        .status.success { background-color: var(--success-color); color: white; }
        .status.error { background-color: var(--error-color); color: white; }
        button { color: white; border: none; padding: 0.75rem 1.5rem; font-size: 1rem; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        button:disabled { background-color: #a0aec0; cursor: not-allowed; }
        #sync-button, #google-connect-button, #generate-sheet-button, #search-button { background-color: var(--primary-color); }
        #update-prices-button { background-color: var(--success-color); margin-top: 1rem; width: 100%; }
        #log-container { background-color: #2d3748; color: #e2e8f0; padding: 1.5rem; border-radius: 8px; font-family: "SF Mono", "Fira Code", monospace; font-size: 0.875rem; height: 300px; overflow-y: auto; white-space: pre-wrap; }
        #sheet-embed-container { display: none; }
        #sheet-iframe { width: 100%; height: 600px; border: none; border-radius: 8px; }
        .search-box { display: flex; gap: 1rem; }
        .search-box input { flex-grow: 1; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; }
        
        /* YENİ: Arama sonuçları için stiller */
        #search-results table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        #search-results th, #search-results td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border-color); }
        #search-results .product-row { cursor: pointer; }
        #search-results .product-row:hover { background-color: #f7fafc; }
        #search-results .variant-details-row { display: none; }
        #search-results .variant-details-row td { padding: 0; }
        #search-results .variant-table { width: 100%; background-color: #f7fafc; }
        #search-results .variant-table th { background-color: #edf2f7; font-size: 0.8rem; text-transform: uppercase; color: #777; }
        #search-results .variant-table td { padding-left: 2rem; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ... (Header ve Navigasyon aynı kalıyor) ... -->
        <header><h1>Vervegrand Sync Paneli</h1></header>
        <nav>
            <a href="#dashboard" class="nav-link active">Ana Sayfa</a>
            <a href="#shopify" class="nav-link">Shopify Yönetimi</a>
        </nav>

        <!-- ANA SAYFA (DASHBOARD) -->
        <div id="page-dashboard" class="page active">
            <div class="grid">
                <div class="card">
                    <h2>Shopify Mağazası</h2>
                    <dl class="info-grid">
                        <dt>Durum:</dt><dd><span id="shopify-status" class="status">Yükleniyor...</span></dd>
                        <dt>Mağaza Adı:</dt><dd id="shopify-name">...</dd>
                        <dt>Email:</dt><dd id="shopify-email">...</dd>
                        <dt>Ürün Sayısı:</dt><dd id="shopify-products">...</dd>
                    </dl>
                </div>
                <div class="card">
                    <h2>XML Kaynağı</h2>
                    <dl class="info-grid">
                        <dt>Durum:</dt><dd><span id="xml-status" class="status">Yükleniyor...</span></dd>
                        <dt>Kaynak URL:</dt><dd id="xml-url">...</dd>
                        <dt>Ürün Sayısı:</dt><dd id="xml-products">...</dd>
                        <dt>Varyant Sayısı:</dt><dd id="xml-variants">...</dd>
                    </dl>
                </div>
            </div>
            <div class="card">
                <div style="display:flex; justify-content: space-between; align-items: center;">
                    <h2>Senkronizasyon</h2>
                    <button id="sync-button">Senkronizasyonu Başlat</button>
                </div>
            </div>
            <div class="card">
                <h2>Senkronizasyon Kayıtları (Log)</h2>
                <div id="log-container">
                    <p class="log-info">Panel yüklendi. Senkronizasyonu başlatmak için butona tıklayın.</p>
                </div>
            </div>
        </div>

        <!-- SHOPIFY YÖNETİM SAYFASI -->
        <div id="page-shopify" class="page">
            <div class="grid">
                <div class="card">
                    <h2>Mağaza İstatistikleri</h2>
                    <dl class="info-grid">
                        <dt>Toplam Ürün:</dt><dd id="shopify-total-products">Yükleniyor...</dd>
                        <dt>Toplam Varyant:</dt><dd id="shopify-total-variants">Yükleniyor...</dd>
                    </dl>
                </div>
                <div class="card">
                    <h2>Fiyat Yönetimi (Google Sheets)</h2>
                    <p>Shopify'daki tüm ürünleri bir Google Sheets dosyasına aktararak maliyet ve satış fiyatlarını kolayca yönetin.</p>
                    <div id="google-auth-container">
                        <button id="google-connect-button">Google Hesabına Bağlan</button>
                    </div>
                    <button id="generate-sheet-button" style="display: none; margin-top: 1rem;">Google Sheets Şablonu Oluştur</button>
                </div>
            </div>
            
            <div id="sheet-embed-container" class="card">
                <h2>Google Sheets Düzenleyici</h2>
                <iframe id="sheet-iframe" src=""></iframe>
                <button id="update-prices-button">Fiyatları Shopify'a Güncelle</button>
            </div>

            <!-- DÜZENLEME: Ürün arama kartı -->
            <div class="card">
                <h2>Ürün Arama</h2>
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="Ürün adı veya SKU ile ara...">
                    <button id="search-button">Ara</button>
                </div>
                <div id="search-results"></div>
            </div>
        </div>
    </div>

    <script>
        // --- UYARI: Bu bölümdeki değişken tanımlamaları, HTML'deki ID'ler ile eşleşmelidir. ---
        // --- Değişiklik yaparken dikkatli olun. ---

        // --- DEĞİŞKENLER ---
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page');
        const logContainer = document.getElementById('log-container');
        const syncButton = document.getElementById('sync-button');
        
        // Dashboard elementleri
        const shopifyStatusEl = document.getElementById('shopify-status');
        const shopifyNameEl = document.getElementById('shopify-name');
        const shopifyEmailEl = document.getElementById('shopify-email');
        const shopifyProductsEl = document.getElementById('shopify-products'); 
        const xmlStatusEl = document.getElementById('xml-status');
        const xmlUrlEl = document.getElementById('xml-url');
        const xmlProductsEl = document.getElementById('xml-products');
        const xmlVariantsEl = document.getElementById('xml-variants');

        // Shopify Yönetim sayfası elementleri
        const googleConnectButton = document.getElementById('google-connect-button');
        const generateSheetButton = document.getElementById('generate-sheet-button');
        const googleAuthContainer = document.getElementById('google-auth-container');
        const sheetEmbedContainer = document.getElementById('sheet-embed-container');
        const sheetIframe = document.getElementById('sheet-iframe');
        const shopifyTotalProductsEl = document.getElementById('shopify-total-products');
        const shopifyTotalVariantsEl = document.getElementById('shopify-total-variants');
        const updatePricesButton = document.getElementById('update-prices-button');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const searchResultsContainer = document.getElementById('search-results');
        let shopifyPageLoaded = false;

        // --- FONKSİYONLAR ---
        function addLog(message, level = 'info') {
            const p = document.createElement('p');
            p.className = `log-${level}`;
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(p);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function updateDashboardStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) throw new Error('Sunucu yanıtı başarısız.');
                const data = await response.json();
                shopifyStatusEl.textContent = data.shopify.success ? 'Bağlı' : 'Bağlantı Hatası';
                shopifyStatusEl.className = `status ${data.shopify.success ? 'success' : 'error'}`;
                shopifyNameEl.textContent = data.shopify.name || 'N/A';
                shopifyEmailEl.textContent = data.shopify.email || 'N/A';
                shopifyProductsEl.textContent = data.shopify.productCount ?? 'N/A';
                xmlStatusEl.textContent = data.xml.success ? 'Ulaşılabilir' : 'Ulaşılamıyor';
                xmlStatusEl.className = `status ${data.xml.success ? 'success' : 'error'}`;
                xmlUrlEl.textContent = data.xml.url || 'N/A';
                xmlProductsEl.textContent = data.xml.productCount ?? 'N/A';
                xmlVariantsEl.textContent = data.xml.variantCount ?? 'N/A';
            } catch (error) {
                console.error("Dashboard status update failed:", error);
                addLog('Kaynak bilgileri alınamadı.', 'error');
            }
        }

        async function updateShopifyManagementStats() {
            if (shopifyPageLoaded) return;
            try {
                const response = await fetch('/api/shopify/stats');
                if (!response.ok) throw new Error('Sunucu yanıtı başarısız.');
                const data = await response.json();
                shopifyTotalProductsEl.textContent = data.productCount ?? 'N/A';
                shopifyTotalVariantsEl.textContent = data.variantCount ?? 'N/A';
                shopifyPageLoaded = true;
            } catch (error) {
                console.error("Shopify stats update failed:", error);
                shopifyTotalProductsEl.textContent = 'Hata';
                shopifyTotalVariantsEl.textContent = 'Hata';
            }
        }

        function showSheet(url) {
            const embedUrl = url.replace('/edit', '/edit?rm=minimal');
            sheetIframe.src = embedUrl;
            sheetEmbedContainer.style.display = 'block';
        }

        async function checkGoogleAuthStatus() {
            try {
                const response = await fetch('/api/google/status');
                if (!response.ok) throw new Error('Sunucu yanıtı başarısız.');
                const data = await response.json();
                const isAuth = data.authenticated;
                
                googleAuthContainer.innerHTML = isAuth ? '<p style="color: var(--success-color); font-weight: 600;">✓ Google Hesabı Bağlı</p>' : '';
                if (!isAuth) googleAuthContainer.appendChild(googleConnectButton);
                
                googleConnectButton.style.display = isAuth ? 'none' : 'block';
                generateSheetButton.style.display = isAuth ? 'block' : 'none';
            } catch (error) {
                console.error('Google auth status error', error);
                googleAuthContainer.innerHTML = '<p style="color: var(--error-color);">Bağlantı durumu kontrol edilemedi.</p>';
            }
        }

        async function checkExistingSheet() {
            try {
                const response = await fetch('/api/google/sheet-info');
                if (!response.ok) throw new Error('Sunucu yanıtı başarısız.');
                const data = await response.json();
                if (data.exists && data.url) {
                    showSheet(data.url);
                }
            } catch (error) {
                console.error('Mevcut sheet kontrol edilirken hata:', error);
            }
        }

        // --- EVENT LISTENERS ---
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                pages.forEach(page => page.classList.toggle('active', page.id === `page-${targetId}`));
                navLinks.forEach(navLink => navLink.classList.toggle('active', navLink.getAttribute('href') === `#${targetId}`));
                if (targetId === 'shopify') {
                    updateShopifyManagementStats();
                }
            });
        });

        syncButton.addEventListener('click', async () => {
            syncButton.disabled = true;
            syncButton.textContent = 'Senkronize Ediliyor...';
            addLog('Senkronizasyon talebi sunucuya iletildi.', 'warn');
            try {
                await fetch('/api/sync', { method: 'POST' });
            } catch (error) {
                addLog(`Senkronizasyon başlatılamadı: ${error.message}`, 'error');
            }
            setTimeout(() => {
                syncButton.disabled = false;
                syncButton.textContent = 'Senkronizasyonu Başlat';
            }, 5000);
        });

        googleConnectButton.addEventListener('click', () => {
            window.open('/api/google/auth', 'authWindow', 'width=500,height=600');
        });

        window.addEventListener('message', (event) => {
            if (event.data === 'google-auth-success') {
                addLog('Google kimlik doğrulaması başarılı!', 'success');
                checkGoogleAuthStatus();
            }
        });

        generateSheetButton.addEventListener('click', async () => {
            generateSheetButton.disabled = true;
            generateSheetButton.textContent = 'Oluşturuluyor...';
            addLog('Google Sheets şablonu oluşturma işlemi başlatılıyor...', 'warn');
            try {
                const response = await fetch('/api/shopify/generate-sheet', { method: 'POST' });
                if (!response.ok) throw new Error('Sunucu yanıtı başarısız.');
                const data = await response.json();
                if (data.url) showSheet(data.url);
            } catch (error) {
                addLog(`İşlem başlatılamadı: ${error.message}`, 'error');
            }
            generateSheetButton.disabled = false;
            generateSheetButton.textContent = 'Google Sheets Şablonu Oluştur';
        });

        updatePricesButton.addEventListener('click', async () => {
            if (!confirm('Google Sheet\'teki fiyatlar Shopify\'a aktarılacak. Bu işlem geri alınamaz. Emin misiniz?')) return;
            updatePricesButton.disabled = true;
            updatePricesButton.textContent = 'Güncelleniyor...';
            addLog('Fiyat güncelleme işlemi sunucuya iletildi...', 'warn');
            try {
                const response = await fetch('/api/shopify/update-prices-from-sheet', { method: 'POST' });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Sunucu yanıtı başarısız.');
                }
                addLog('Sunucu, fiyat güncelleme talebini kabul etti. İşlem arka planda devam ediyor.', 'info');
            } catch (error) {
                addLog(`Fiyat güncelleme başlatılamadı: ${error.message}`, 'error');
                updatePricesButton.disabled = false;
                updatePricesButton.textContent = 'Fiyatları Shopify\'a Güncelle';
            }
        });

        // DÜZENLEME: Arama butonu için olay dinleyici
        searchButton.addEventListener('click', async () => {
            const query = searchInput.value.trim();
            if (!query) return;
            searchButton.disabled = true;
            searchButton.textContent = 'Aranıyor...';
            searchResultsContainer.innerHTML = '<p>Lütfen bekleyin...</p>';
            try {
                const response = await fetch(`/api/shopify/search?q=${encodeURIComponent(query)}`);
                const products = await response.json();
                
                if (products.length === 0) {
                    searchResultsContainer.innerHTML = '<p>Aramanızla eşleşen ürün bulunamadı.</p>';
                    return;
                }

                let html = '<table>';
                for (const product of products) {
                    // Ana ürün satırı
                    html += `<tr class="product-row" data-product-id="${product.id}">
                                <td><strong>${product.title}</strong> (${product.variants.length} varyant)</td>
                             </tr>`;
                    
                    // Gizli varyant detayları satırı
                    html += `<tr class="variant-details-row" id="details-${product.id}">
                                <td colspan="1">
                                    <table class="variant-table">
                                        <thead>
                                            <tr>
                                                <th>Varyant</th>
                                                <th>SKU</th>
                                                <th>Fiyat</th>
                                                <th>Stok</th>
                                                <th>Barkod</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                    for (const variant of product.variants) {
                        html += `<tr>
                                    <td>${variant.title}</td>
                                    <td>${variant.sku || 'N/A'}</td>
                                    <td>${variant.price}</td>
                                    <td>${variant.inventoryQuantity ?? 'N/A'}</td>
                                    <td>${variant.barcode || 'N/A'}</td>
                                 </tr>`;
                    }
                    html += `           </tbody>
                                    </table>
                                </td>
                             </tr>`;
                }
                html += '</table>';
                searchResultsContainer.innerHTML = html;

            } catch (error) {
                searchResultsContainer.innerHTML = '<p style="color: var(--error-color);">Arama sırasında bir hata oluştu.</p>';
            } finally {
                searchButton.disabled = false;
                searchButton.textContent = 'Ara';
            }
        });

        // DÜZENLEME: Tıklama olayını tüm arama sonuçları kapsayıcısına ekleme (Event Delegation)
        searchResultsContainer.addEventListener('click', (event) => {
            const productRow = event.target.closest('.product-row');
            if (productRow) {
                const productId = productRow.dataset.productId;
                const detailsRow = document.getElementById(`details-${productId}`);
                if (detailsRow) {
                    // Stili değiştirerek göster/gizle
                    const isVisible = detailsRow.style.display === 'table-row';
                    detailsRow.style.display = isVisible ? 'none' : 'table-row';
                }
            }
        });

        // --- SAYFA YÜKLENİNCE ÇALIŞAN KODLAR ---
        document.addEventListener('DOMContentLoaded', () => {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            const ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket bağlantısı kuruldu.');
                addLog('Sunucuya başarıyla bağlanıldı.', 'success');
                // Bağlantı kurulunca sunucudan güncel durumu iste
                updateDashboardStatus();
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                switch (data.type) {
                    case 'log':
                        addLog(data.message, data.level);
                        break;
                    case 'sync_complete':
                        addLog(data.message, 'success');
                        updateDashboardStatus(); // Senkronizasyon bitince durumu güncelle
                        updatePricesButton.disabled = false;
                        updatePricesButton.textContent = 'Fiyatları Shopify\'a Güncelle';
                        break;
                    case 'price_update_complete':
                        addLog(data.message, 'success');
                        updatePricesButton.disabled = false;
                        updatePricesButton.textContent = 'Fiyatları Shopify\'a Güncelle';
                        break;
                }
            };

            ws.onclose = () => {
                console.log('WebSocket bağlantısı kapandı.');
                addLog('Sunucu bağlantısı koptu. Sayfayı yenileyin.', 'error');
            };

            ws.onerror = (error) => {
                console.error('WebSocket hatası:', error);
                addLog('Sunucu bağlantısında bir hata oluştu.', 'error');
            };

            // Mevcut fonksiyonları çağır
            checkGoogleAuthStatus();
            checkExistingSheet();
        });
    </script>
</body>
</html>